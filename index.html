<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
      integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
      crossorigin=""
    />
    <script  
    src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
      integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
      crossorigin=""
    ></script>
    <script src="https://unpkg.com/osmtogeojson@2.2.12/osmtogeojson.js"></script>

    <!-- <script src="./xml2json.js">  </script> -->
    <style>
      body {
        padding: 0;
        margin: 0;
      }
      html, body, #map {
        height: 100%;
        width: 100%;
      }
      #overpass-api-controls {
        padding: 10px;
        background-color: rgb(255, 255, 255);
      }
      #overpass-api-controls a {
        display: inline;
      }
    </style>

    <title>Fetch JSON from API and map lat lon</title>
  </head>
  <body>
   

    <div id="map"></div>

    <script>
      // Making a map and tiles
      const map = L.map('map').setView([27.717245, 85.323959], 12);
      const attribution =
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';
      const tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
      const tiles = L.tileLayer(tileUrl, { attribution });
      tiles.addTo(map);

      function buildOverpassApiUrl(map, overpassQuery, place) {
        let customBounds = {
          default: map.getBounds().getSouth() + ',' + map.getBounds().getWest() + ',' + map.getBounds().getNorth() + ',' + map.getBounds().getEast(),
          kathmandu: '3604583247',
        }
        let searchAreaQuery = `area(${customBounds[place]})->.searchArea;`

        var nodeQuery = 'node[' + overpassQuery + '](area.searchArea);';
        var wayQuery = 'way[' + overpassQuery + '](area.searchArea);';
        var relationQuery = 'relation[' + overpassQuery + '](area.searchArea);';
        var query = '?data=[out:json][timeout:25];' + searchAreaQuery + '(' + nodeQuery + wayQuery + relationQuery + ');out body geom;';
        var baseUrl = 'http://overpass-api.de/api/interpreter';
        var resultUrl = baseUrl + query;
        return resultUrl;
      }

      async function getMapResource() {
        let overpassApiUrl = buildOverpassApiUrl(map, 'amenity=school', 'kathmandu');          
        const response = await fetch(overpassApiUrl);                
        const data = await response.json();
        let geoData = osmtogeojson(data);
        
        const resultLayer = L.geoJson(geoData, {
            style: (feature) => {
              return {color: "#330099"};
            },
            filter: (feature, layer) => {
              var isPolygon = (feature.geometry) && (feature.geometry.type) && (feature.geometry.type === "Polygon");
              if (isPolygon) {
                feature.geometry.type = "Point";
                var polygonCenter = L.latLngBounds(feature.geometry.coordinates[0]).getCenter();
                feature.geometry.coordinates = [ polygonCenter.lat, polygonCenter.lng ];
              }
              return true;
            },
            onEachFeature: (feature, layer) => {
              var popupContent = "";
              popupContent = popupContent + "<dt>@id</dt><dd>" + feature.properties.type + "/" + feature.properties.id + "</dd>";
              var keys = Object.keys(feature.properties.tags);
              keys.forEach(function (key) {
                popupContent = popupContent + "<dt>" + key + "</dt><dd>" + feature.properties.tags[key] + "</dd>";
              });
              popupContent = popupContent + "</dl>"
              layer.bindPopup(popupContent);
            }
          }).addTo(map);

        

        
        // marker[i].setLatLng([latitude, longitude]);         
      }
        //  document.getElementById('lat').textContent = latitude.toFixed(2);
        //  document.getElementById('lon').textContent = longitude.toFixed(2);
    // }
    getMapResource();
      // setInterval(getISS, 1000);
    </script>
  </body>
</html>